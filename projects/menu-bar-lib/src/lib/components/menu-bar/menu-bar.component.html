<div class="d-flex flex-column h-100" [class.collapsed]="isCollapsed()">
  <!-- Sidebar Header -->
  <mat-toolbar class="sidebar-header d-flex justify-content-between align-items-center">
    <div class="header-content d-flex align-items-center" *ngIf="!isCollapsed()">
      <div class="role-info d-flex align-items-center">
        <mat-icon class="me-2">account_circle</mat-icon>
        <div class="role-details">
          <div class="fw-bold">
            {{ currentRoles()[0]?.description || "Menu" }}
          </div>
          <div class="small text-muted" *ngIf="currentRoles()[0]?.isPriorityRole">
            <mat-icon class="me-1" style="font-size: 1rem; height: 1rem; width: 1rem;">star</mat-icon>
            Priority Role
          </div>
        </div>
      </div>
    </div>

    <button
      mat-icon-button
      (click)="toggleSidebar()"
      [title]="isCollapsed() ? 'Expand' : 'Collapse'"
    >
      <mat-icon>{{ isCollapsed() ? 'menu' : 'close' }}</mat-icon>
    </button>
  </mat-toolbar>

  <!-- Search Bar -->
  <div class="p-2" *ngIf="!isCollapsed() && config().enableSearch">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <button mat-icon-button (click)="toggleSearch()" title="Search Menu">
        <mat-icon>search</mat-icon>
      </button>
      <span class="flex-grow-1 text-end small text-muted" *ngIf="showSearch()">Search</span>
    </div>

    <div *ngIf="showSearch()">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Search tasks...</mat-label>
        <input
          matInput
          type="text"
          [value]="searchText()"
          (input)="onSearch()"
          name="searchText"
        />
        <button
          *ngIf="searchText()"
          matSuffix
          mat-icon-button
          (click)="clearSearch()"
        >
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
    </div>

    <!-- Search Results -->
    <div class="search-results mt-2" *ngIf="searchResults().length > 0">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="small text-muted">{{ searchResults().length }} results</span>
        <button mat-icon-button (click)="clearSearch()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <mat-nav-list>
        <mat-list-item
          *ngFor="let result of searchResults(); trackBy: trackBySearchResult"
          (click)="onTaskClick(menuBarService.findTaskByCode(result.taskCode)!);"
          class="d-flex align-items-center"
        >
          <mat-icon matListItemIcon>description</mat-icon>
          <div matListItemTitle>{{ result.caption }}</div>
          <div matListItemLine class="small text-muted">{{ result.path }}</div>
        </mat-list-item>
      </mat-nav-list>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="d-flex justify-content-around p-2" *ngIf="!isCollapsed()">
    <button mat-icon-button (click)="expandAll()" title="Expand All">
      <mat-icon>add_box</mat-icon>
    </button>
    <button mat-icon-button (click)="collapseAll()" title="Collapse All">
      <mat-icon>indeterminate_check_box</mat-icon>
    </button>
    <button
      mat-icon-button
      [color]="config().showTaskCodes ? 'primary' : undefined"
      (click)="toggleTaskCodes()"
      title="Toggle Task Codes"
    >
      <mat-icon>code</mat-icon>
    </button>
    <button
      mat-icon-button
      [color]="config().viewMode === MenuViewMode.LIST ? 'primary' : undefined"
      (click)="switchViewMode(MenuViewMode.LIST)"
      title="List View"
    >
      <mat-icon>list</mat-icon>
    </button>
    <button
      mat-icon-button
      [color]="config().viewMode === MenuViewMode.GRAPHICAL ? 'primary' : undefined"
      (click)="switchViewMode(MenuViewMode.GRAPHICAL)"
      title="Graphical View"
    >
      <mat-icon>grid_on</mat-icon>
    </button>
  </div>
  <mat-divider></mat-divider>

  <!-- Menu Groups -->
  <div class="menu-content flex-grow-1 overflow-auto" *ngIf="!isCollapsed()">
    <mat-accordion>
      <mat-expansion-panel
        *ngFor="let group of menuGroups(); trackBy: trackByMenuCode"
        [expanded]="group.isExpanded"
        (opened)="toggleGroup(group.menuCode)"
        (closed)="toggleGroup(group.menuCode)"
      >
        <mat-expansion-panel-header>
          <mat-panel-title class="d-flex align-items-center">
            <mat-icon class="me-2">{{ group.icon || 'folder' }}</mat-icon>
            <span>{{ group.description }}</span>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <!-- Group Tasks -->
        <mat-nav-list *ngIf="config().viewMode === MenuViewMode.LIST">
          <mat-list-item
            *ngFor="let task of group.tasks; trackBy: trackByTaskCode"
            (click)="onTaskClick(task)"
            class="d-flex align-items-center"
          >
            <mat-icon matListItemIcon>{{ task.icon || 'description' }}</mat-icon>
            <div matListItemTitle>
              <span *ngIf="config().showTaskCodes" class="small text-muted me-1">
                [{{ task.taskCode }}]
              </span>
              {{ task.caption }}
            </div>
            <button
              mat-icon-button
              (click)="toggleFavorite(task, $event)"
              [color]="isFavorite(task.taskCode) ? 'accent' : undefined"
              matListItemMeta
              [title]="
                isFavorite(task.taskCode)
                  ? 'Remove from favorites'
                  : 'Add to favorites'
              "
            >
              <mat-icon>{{ isFavorite(task.taskCode) ? 'star' : 'star_border' }}</mat-icon>
            </button>
          </mat-list-item>
        </mat-nav-list>

        <!-- Graphical View -->
        <div
          *ngIf="config().viewMode === MenuViewMode.GRAPHICAL"
          class="row row-cols-2 g-2 p-2"
        >
          <div
            *ngFor="let task of group.tasks; trackBy: trackByTaskCode"
            class="col"
          >
            <mat-card
              class="task-card text-center h-100 d-flex flex-column justify-content-center align-items-center"
              [class.favorite]="isFavorite(task.taskCode)"
              (click)="onTaskClick(task)"
            >
              <mat-icon class="mb-2" style="font-size: 2rem; height: 2rem; width: 2rem;">{{ task.icon || 'description' }}</mat-icon>
              <div *ngIf="config().showTaskCodes" class="small text-muted">
                [{{ task.taskCode }}]
              </div>
              <div class="fw-bold">{{ task.caption }}</div>

              <button
                mat-icon-button
                (click)="toggleFavorite(task, $event)"
                [color]="isFavorite(task.taskCode) ? 'accent' : undefined"
                class="position-absolute top-0 end-0 m-1"
              >
                <mat-icon>{{ isFavorite(task.taskCode) ? 'star' : 'star_border' }}</mat-icon>
              </button>
            </mat-card>
          </div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>

    <!-- Empty State -->
    <div class="text-center p-4" *ngIf="menuGroups().length === 0">
      <mat-icon style="font-size: 3rem; height: 3rem; width: 3rem;" color="accent">folder_open</mat-icon>
      <p class="text-muted mt-2">No menu items available</p>
    </div>
  </div>

  <!-- Collapsed State Icons -->
  <div class="collapsed-menu p-2" *ngIf="isCollapsed()">
    <div
      *ngFor="let group of menuGroups(); trackBy: trackByMenuCode"
      class="text-center py-2"
      [title]="group.description"
    >
      <mat-icon>{{ group.icon || 'folder' }}</mat-icon>
    </div>
  </div>
</div>
