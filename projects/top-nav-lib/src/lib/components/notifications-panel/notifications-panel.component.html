<mat-sidenav
  #notificationSidenav
  [opened]="panelState().isOpen"
  (closedStart)="closePanel()"
  mode="over"
  position="end"
  class="notification-panel"
>
  <div class="d-flex flex-column h-100">
    <!-- Panel Header -->
    <mat-toolbar class="notification-header d-flex justify-content-between align-items-center">
      <h4 class="sidebar-title m-0 d-flex align-items-center">
        <mat-icon class="me-2">notifications</mat-icon>
        Notifications
        @if (unreadCount() > 0) {
        <span mat-badge [matBadge]="unreadCount()" matBadgeColor="warn" matBadgeOverlap="false"></span>
        }
      </h4>
      <button mat-icon-button (click)="closePanel()">
        <mat-icon>close</mat-icon>
      </button>
    </mat-toolbar>

    <!-- Action Buttons -->
    <div class="notification-actions p-3 d-flex gap-2">
      @if (hasNotifications()) {
      <button
        mat-stroked-button
        color="primary"
        (click)="markAllAsRead()"
        [disabled]="unreadCount() === 0"
        class="flex-grow-1"
      >
        <mat-icon class="me-1">done_all</mat-icon>
        Mark All Read
      </button>

      @if (hasSelectedNotifications()) {
      <button
        mat-stroked-button
        color="warn"
        (click)="deleteSelected()"
        class="flex-grow-1"
      >
        <mat-icon class="me-1">delete</mat-icon>
        Delete ({{ selectedNotifications().size }})
      </button>
      } }
    </div>

    <!-- Notifications List -->
    <div class="notifications-container flex-grow-1 overflow-auto">
      @if (!isMessageViewOpen()) {
      <!-- List View -->
      @if (hasNotifications()) {
      <mat-selection-list #notificationList (selectionChange)="toggleNotificationSelection($event.options[0].value)">
        @for (notification of notifications(); track notification.id) {
        <mat-list-option
          [value]="notification.id"
          [selected]="isSelected(notification.id)"
          [class.unread]="!notification.isRead"
          [class.task-notification]="notification.type === NotificationType.TASK"
          [class.message-notification]="notification.type !== NotificationType.TASK"
        >
          <mat-checkbox matListItemIcon [checked]="isSelected(notification.id)" (change)="toggleNotificationSelection(notification.id)"></mat-checkbox>
          <div matListItemTitle (click)="onNotificationClick(notification)">
            <div class="d-flex align-items-center">
              <mat-icon class="me-2">{{ getNotificationIcon(notification) }}</mat-icon>
              <span class="fw-bold">{{ notification.title }}</span>
              @if (!notification.isRead) {
              <mat-icon color="accent" class="ms-auto">fiber_manual_record</mat-icon>
              }
            </div>
            <div class="small text-muted mt-1">
              {{ notification.message }}
            </div>
            <div class="small text-muted mt-1 d-flex justify-content-between">
              <span>{{ formatTimestamp(notification.timestamp) }}</span>
              @if (notification.type === NotificationType.TASK && notification.taskCode) {
              <span>
                <mat-icon style="font-size: 1rem; height: 1rem; width: 1rem;">code</mat-icon>
                {{ notification.taskCode }}
              </span>
              }
            </div>
          </div>
        </mat-list-option>
        }
      </mat-selection-list>
      } @else {
      <!-- Empty State -->
      <div class="empty-state text-center p-4">
        <mat-icon style="font-size: 4rem; height: 4rem; width: 4rem;" color="accent">notifications_off</mat-icon>
        <p class="text-muted mt-2">No notifications</p>
      </div>
      } } @else {
      <!-- Message View -->
      <div class="message-view p-3">
        <div class="message-header d-flex align-items-center mb-3">
          <button mat-icon-button (click)="closeMessageView()">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <h5 class="m-0 ms-2">Notification Details</h5>
        </div>

        @if (panelState().selectedNotification; as notification) {
        <mat-card>
          <mat-card-header class="d-flex align-items-center">
            <mat-icon mat-card-avatar>{{ getNotificationIcon(notification) }}</mat-icon>
            <mat-card-title>{{ notification.title }}</mat-card-title>
            <mat-card-subtitle>{{ formatTimestamp(notification.timestamp) }}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content class="mt-3">
            <p>{{ notification.message }}</p>
          </mat-card-content>
          @if (notification.actionUrl) {
          <mat-card-actions>
            <a mat-button [href]="notification.actionUrl" target="_blank">
              {{ notification.actionText || "View Details" }}
            </a>
          </mat-card-actions>
          }
        </mat-card>
        }
      </div>
      }
    </div>
  </div>
</mat-sidenav>
